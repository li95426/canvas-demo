"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Canvas=function(){function t(e){_classCallCheck(this,t),this.boxDom=e.boxDom,this.penbtn=e.penbtn,this.deleteline=e.deleteline,this.addpicbtn=e.addpicbtn,this.savePic=e.savePic,this.move=e.move,this.colorbtn=e.colorbtn,this.outbox=e.outbox,this.lines=e.lines,this.picUrl="",this.ctx=null,this.stroke=e.strokeStyle,this.width=e.width,this.height=e.height,this.background=e.background,this.flag=2,this.start=[],this.end=[],this.allLine=[],this.allText=[],this.popUp=null,this.picLayer=null,this.picCtx=null,this.hideLine=[],this.testBrowser(),this.creatUi()}return _createClass(t,[{key:"testBrowser",value:function(){this.boxDom.getContext("2d")?console.log("该浏览器支持canvas"):alert("请升级浏览器")}},{key:"creatUi",value:function(){var a=this;this.ctx=this.boxDom.getContext("2d"),this.boxDom.width=this.width,this.boxDom.height=this.height,this.boxDom.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);",this.boxDom.style.zIndex="10",this.setStrokeStyle(),this.boxDom.style.background=this.background,this.creatPicLayer(),this.creatPopup(),this.penbtn.onclick=function(){a.flag=0,a.mark()},this.deleteline.onclick=function(){a.flag=1,a.delete()},this.move.onclick=function(){a.flag=2,a.moves()},this.addpicbtn.onchange=function(){var e=new FileReader,t=a.addpicbtn.files[0];e.readAsDataURL(t),e.onload=function(e){a.picUrl=e.target.result,a.DrawPic()}},this.savePic.onclick=function(){var e=a.picCtx.getImageData(0,0,a.width,a.height),n=document.createElement("canvas"),i=n.getContext("2d");n.width=a.width,n.height=a.height,i.putImageData(e,0,0);var t=a.boxDom.toDataURL(),o=new Image;o.src=t,o.onload=function(){i.drawImage(o,0,0);var e=n.toDataURL(),t=document.createElement("a");t.href=e,t.download="name",t.click(),console.log(a.allLine)}}}},{key:"setStrokeStyle",value:function(){this.ctx.strokeStyle=this.stroke}},{key:"mark",value:function(){var i=this;this.boxDom.onmousedown=function(e){if(0==i.flag&&"none"==i.popUp.style.display){var t=i.getCanvasPos(i.boxDom,e),n=[t.x,t.y];i.start=n,i.boxDom.onmousemove=function(e){var t=i.getCanvasPos(i.boxDom,e),n=[t.x,t.y];i.end=n,i.clearbord(),i.drawall(),i.Drawline({start:i.start,end:i.end})}}},this.boxDom.onmouseup=function(e){if(0==i.flag&&"none"==i.popUp.style.display){i.boxDom.onmousemove=null;var t=i.getCanvasPos(i.boxDom,e);i.end=[t.x,t.y],i.start[0]!=i.end[0]&&i.start[1]!=i.end[1]&&(i.allLine.push({start:i.start,end:i.end,color:i.stroke}),i.popUp.style.display="block",i.popUp.style.top=i.end[1]+120+"px",i.popUp.style.left=i.end[0]+320+"px"),i.clearbord(),i.drawall()}}}},{key:"getCanvasPos",value:function(e,t){var n=e.getBoundingClientRect(),i=parseInt(this.getStyles(e).borderLeftWidth),o=parseInt(this.getStyles(e).borderTopWidth);return{x:t.clientX-n.left-i,y:t.clientY-n.top-o}}},{key:"getStyles",value:function(e){return document.defaultView.getComputedStyle(e)}},{key:"delete",value:function(){var i=this;this.boxDom.onclick=function(e){if(1==i.flag)for(var t in i.allLine){var n=i.getCanvasPos(i.boxDom,e);i.containStroke(i.allLine[t].start[0],i.allLine[t].start[1],i.allLine[t].end[0],i.allLine[t].end[1],10,n.x,n.y)&&i.allLine.splice(t,1),i.ctx.clearRect(0,0,i.width,i.height),i.drawall()}i.setLine()}}},{key:"moves",value:function(){var m=this;this.boxDom.onmousemove=function(t){if(2==m.flag){var e=function(n){var e=m.getCanvasPos(m.boxDom,t);m.containStroke(m.allLine[n].start[0],m.allLine[n].start[1],m.allLine[n].end[0],m.allLine[n].end[1],10,e.x,e.y)?(m.allLine[n].color="#0099FF",m.allLine[n].circle=!0,m.clearbord(),m.drawall(),"start"==m.judgeCirle(m.allLine[n],t)?(m.boxDom.onmousedown=function(){m.boxDom.onmousemove=function(e){var t=m.getCanvasPos(m.boxDom,e);m.allLine[n].start=[t.x,t.y],m.clearbord(),m.drawall()}},m.boxDom.onmouseup=function(){m.boxDom.onmousedown=null,m.boxDom.onmousemove=null,m.moves()}):"end"==m.judgeCirle(m.allLine[n],t)?(m.boxDom.onmousedown=function(){m.boxDom.onmousemove=function(e){var t=m.getCanvasPos(m.boxDom,e);m.allLine[n].end=[t.x,t.y],m.clearbord(),m.drawall()}},m.boxDom.onmouseup=function(){m.boxDom.onmousedown=null,m.boxDom.onmousemove=null,m.moves()}):0==m.judgeCirle(m.allLine[n],t)&&m.moves()):m.containStroke(m.allLine[n].start[0],m.allLine[n].start[1],m.allLine[n].end[0],m.allLine[n].end[1],10,t.pageX-m.boxDom.offsetLeft,t.pageY-m.boxDom.offsetTop)||(m.allLine[n].color=m.stroke,m.allLine[n].circle=!1,m.clearbord(),m.drawall())};for(var n in m.allLine)e(n)}},this.boxDom.onmousedown=function(n){if(2==m.flag){var e=function(h){var e=m.getCanvasPos(m.boxDom,n);if(m.containStroke(m.allLine[h].start[0],m.allLine[h].start[1],m.allLine[h].end[0],m.allLine[h].end[1],10,e.x,e.y)){var d=m.allLine[h].start,u=m.allLine[h].end,t=m.getCanvasPos(m.boxDom,n),p=t.x,x=t.y;m.boxDom.onmousemove=function(e){m.allLine[h].color="#0099FF";var t=m.getCanvasPos(m.boxDom,e),n=t.x,i=t.y,o=n-p,a=i-x,l=o+d[0],s=a+d[1],r=o+u[0],c=a+u[1];m.allLine[h].start=[l,s],m.allLine[h].end=[r,c],m.clearbord(),m.drawall()}}};for(var t in m.allLine)e(t)}},this.boxDom.onmouseup=function(e){m.boxDom.onmousemove=null,m.moves()}}},{key:"creatPicLayer",value:function(){this.picLayer=document.createElement("canvas"),this.picCtx=this.picLayer.getContext("2d"),this.picLayer.width=this.width,this.picLayer.height=this.height,this.picLayer.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);",this.outbox.appendChild(this.picLayer)}},{key:"Drawline",value:function(e){e.color&&(this.ctx.strokeStyle=e.color),this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e.start[0],e.start[1]),this.ctx.lineTo(e.end[0],e.end[1]),this.ctx.stroke()}},{key:"DrawBox",value:function(e){this.ctx.beginPath(),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.fillRect(e.end[0]+2.5,e.end[1]+5,this.ctx.measureText(e.text.value).width+5,20)}},{key:"DrawText",value:function(e){this.ctx.fillStyle="yellow",this.ctx.font="30px",this.ctx.fillText(e.text.value,e.end[0]+5,e.end[1]+18)}},{key:"DrawRound",value:function(e){this.ctx.beginPath(),this.ctx.strokeStyle="#33FFFF",this.ctx.arc(e.start[0],e.start[1],6,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="#33FFFF",this.ctx.arc(e.end[0],e.end[1],6,0,2*Math.PI),this.ctx.stroke()}},{key:"DrawPic",value:function(e){var t=this,n=new Image;n.src=this.picUrl,n.onload=function(){t.picCtx.drawImage(n,50,50,t.width-100,t.height-100)}}},{key:"drawall",value:function(){for(var e in this.allLine)this.Drawline(this.allLine[e]),this.allLine[e].fangkuang&&this.DrawBox(this.allLine[e]),this.allLine[e].text&&this.DrawText(this.allLine[e]),this.allLine[e].circle&&this.DrawRound(this.allLine[e])}},{key:"clearbord",value:function(){this.ctx.clearRect(0,0,this.width,this.height)}},{key:"setLine",value:function(){var i=this;for(var e in this.lines.innerHTML="",this.allLine){var t=document.createElement("div"),n=document.createElement("p"),o=document.createElement("span");t.style.cssText="width:100%;height:50px;background:#99CCCC;padding:10px 20px;border:1px solid #ddd;",n.style.cssText="float:left;line-height:50px;width:180px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap",n.title=this.allLine[e].text.value,o.style.cssText="cursor:pointer;text-align:center;float:left;display:block;width:50px;height:25px;background:#FFCCCC;border-radius:3px;margin-top:12.5px;line-height:25px;",n.innerHTML=this.allLine[e].text.value,o.innerHTML="显示",o.setAttribute("time",this.allLine[e].time),t.appendChild(n),t.appendChild(o),this.lines.appendChild(t),o.onclick=function(e){if("显示"==e.target.innerHTML){for(var t in e.target.innerHTML="隐藏",i.allLine)i.allLine[t].time==e.target.getAttribute("time")&&(i.hideLine.push(i.allLine[t]),i.allLine.splice(t,1));i.clearbord(),i.drawall()}else if("隐藏"==e.target.innerHTML){for(var n in e.target.innerHTML="显示",i.hideLine)i.hideLine[n].time==e.target.getAttribute("time")&&(i.allLine.push(i.hideLine[n]),i.hideLine.splice(n,1));i.sortTime(i.allLine),i.clearbord(),i.drawall()}}}}},{key:"sortTime",value:function(e){e=e.sort(this.sortNumber)}},{key:"sortNumber",value:function(e,t){return e-t}},{key:"containStroke",value:function(e,t,n,i,o,a,l){if(0===o)return!1;var s=o,r=0;if(t+s<l&&i+s<l||l<t-s&&l<i-s||e+s<a&&n+s<a||a<e-s&&a<n-s)return!1;if(e===n)return Math.abs(a-e)<=s/2;var c=(r=(t-i)/(e-n))*a-l+(e*i-n*t)/(e-n);return c*c/(r*r+1)<=s/2*s/2}},{key:"judgeCirle",value:function(e,t){var n=this.getCanvasPos(this.boxDom,t),i=n.x,o=n.y,a=Math.sqrt(Math.pow(e.start[0]-i,2)+Math.pow(e.start[1]-o,2)),l=Math.sqrt(Math.pow(e.end[0]-i,2)+Math.pow(e.end[1]-o,2));return a<=6?"start":l<=6?"end":!(6<a&&6<l)&&void 0}},{key:"getTime",value:function(){return(new Date).getTime()}},{key:"creatPopup",value:function(){var e=this;this.popUp=document.createElement("div"),this.popUp.style.cssText="width:184px;height:74px;background:greenyellow;padding:8px;display:none;position:absolute;top:0;left:0;border-radius:5px;z-index:100";var t=document.createElement("label");t.innerHTML="标注信息",this.popUp.appendChild(t);var n=document.createElement("input");n.type="text",n.id="textvalue",n.style.cssText="width:100%;outline:none;border:1px solid #ddd;height:28px;margin-bottom:5px",this.popUp.appendChild(n);var i=document.createElement("div");i.style.cssText="display:flex;justify-content: space-around",this.popUp.appendChild(i);var o=document.createElement("input");o.type="button",o.value="确定",o.id="btn1",o.style.cssText="width:40px;outline:none;height:24px",i.appendChild(o),o.addEventListener("click",function(){e.popUp.style.display="none",e.allLine[e.allLine.length-1].fangkuang={weizhi:e.end},e.allLine[e.allLine.length-1].text={weizhi:e.end,value:n.value},e.allLine[e.allLine.length-1].time=e.getTime(),n.value="",e.clearbord(),e.drawall(),e.setLine()});var a=document.createElement("input");a.type="button",a.id="btn2",a.value="取消",a.style.cssText="width:40px;outline:none;height:24px",i.appendChild(a),a.addEventListener("click",function(){e.popUp.style.display="none",n.value="",e.clearbord(),e.allLine.splice(e.allText.length-1,1),e.drawall()}),document.body.appendChild(this.popUp)}}]),t}();
"use strict";window.onload=function(){var e=document.getElementById("addpicbtn"),t=document.getElementById("cvs"),n=document.getElementById("penbtn"),d=document.getElementById("deleteLine"),o=document.getElementById("move"),m=document.getElementById("colorbtn"),l=document.getElementById("outbox"),c=document.getElementById("savePic");document.getElementById("allLine"),new Canvas({addpicbtn:e,outbox:l,boxDom:t,penbtn:n,deleteline:d,colorbtn:m,strokeStyle:"#6666FF",width:"1000",height:"800",move:o,savePic:c,lines:lines})};